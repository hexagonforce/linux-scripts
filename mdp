#! /usr/bin/python3

from pathlib import Path
from subprocess import run
from subprocess import Popen
from subprocess import DEVNULL
from datetime import datetime
import sys
import os
import shlex

EXIFTOOL_DIR = f'{Path.home()}/.local/bin/Image-ExifTool-12.55/exiftool'
SUPPORTED_FILETYPES = ['.jpg', '.jpeg', '.webp']

def modify(file, date):
    run(shlex.split(
        f'{EXIFTOOL_DIR} ' 
        f'-ModifyDate={date.isoformat()} -CreateDate={date.isoformat()} -DateTimeOriginal={date.isoformat()} '
        '-overwrite_original '
        f'"{file}"'
    ))
    run(shlex.split(f'touch -d {date.isoformat()} "{file}"'))

def is_supported_fileformat(file):
    return file.suffix.lower() in SUPPORTED_FILETYPES
    
def is_new(file):
    res = run(shlex.split(f'{EXIFTOOL_DIR} -exif -if \'$exif\' "{file}"'), stdout=DEVNULL)
    return res.returncode != 0

def convert_to_full_date(datestring):
    res = datetime.fromisoformat(datestring)
    if len(datestring) > 10:
        return res
    res.replace(hour=0,minute=0,second=0)
    return res
    
def loop(files_list):
    for item in files_list:
        print(item.name, end=': ')
        date_is_valid = False
        date = ''
        while not date_is_valid:
            inputdate = input()
            if len(inputdate.strip()) == 0:
                date = ''
                break
            try:
                date = convert_to_full_date(inputdate)
                break
            except ValueError:
                print("Invalid date format. Please input a date according to the ISO8601 standard.")
                print(item.name, end=': ')
                continue
        if date != '':
            modify(item, date)

def main(*args):
    currPath = Path.cwd()
    if not Path(EXIFTOOL_DIR).exists():
        print("ExifTool not found. Please install ExifTool 12.51 and change the EXIFTOOL_DIR variable to the installation directory.")
        exit(-1)

    files_list = list((filter(is_supported_fileformat, currPath.iterdir())))
    files_list.sort(key=lambda x : os.path.getmtime(x))

    if (len(args) > 0):
        if (args[0] == '--new'):
            files_list = list(filter(is_new, files_list))
        elif (args[0] == '--files'):
            files_list = list(filter(is_supported_fileformat, [Path(x) for x in args[1:]]))
        else:
            print(
                f"Arguments: --new (modify only files without EXIF data)\n"
                "--files [files] (modify specific files)"
            )
    loop(files_list)


if __name__ == '__main__':
    main(*sys.argv[1:])
